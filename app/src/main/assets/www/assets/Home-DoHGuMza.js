import{r as m,j as n}from"./About-dplKy6fd.js";import{H as w,L as g}from"./Book-D0YsG2KY.js";function v(t){t=t.split(" --> ")[0];var o=t.split(":"),c=parseInt(o[0]),e=parseInt(o[1]),a=o[2].split(","),s=parseInt(a[0]),r=parseInt(a[1]),l=c*3600+e*60+s+r/1e3;return[l,t]}function j(t,o){return t.replace(/\r\n/mg,`
`).split(`

`).map((e,a)=>{let s=e.split(`
`),r="";for(let i=2;i<s.length;i++)r+=s[i]+" ";let l={id:parseInt(s[0]),time:`${s[1]}`,text:r};if(l.time!="undefined")return l}).filter(e=>e).map(e=>{let[a,s]=v(e.time);return e.start=s,e.time=a,e}).reduce((e,a)=>{if(a.text.toLowerCase().indexOf("chapter ")==0){let s={};return s.index=a.text,s.texts=[a],e.push(s),e}return e[e.length-1].texts.push(a),e},[])}async function x({json:t,audio:o,cover:c,srt:e}){const a=i=>new Promise((u,p)=>{const h=new FileReader;h.onload=()=>u(h.result),h.onerror=p,h.readAsText(i)}),s=await a(t);let r;try{r=JSON.parse(s)}catch{throw new Error("Invalid JSON file")}const l=await a(e);return{data:r,audio:o,cover:c,subtitle:l}}function k({ctx:t}){const o=m.useRef(null),c=async e=>{const a=Array.from(e.target.files);let s,r,l,i,u;a.forEach(f=>{const d=f.name.toLowerCase();d.endsWith(".json")?s=f:d.endsWith(".mp3")||d.endsWith(".webm")?r=f:d.endsWith(".jpg")||d.endsWith(".jpeg")||d.endsWith(".png")||d.endsWith(".webp")?l=f:d.endsWith(".srt")&&(i=f)}),t.uploading=!0,t.refresh();const p=await x({json:s,audio:r,cover:l,srt:i});u=p.data,i=p.subtitle,r=p.audio,l=p.cover;let h=j(i),b={id:u.id,cover:l};b=Object.assign({},b,u),await t.db.add("infos",b),await t.db.add("blobs",{id:u.id,audio:r,text:h}),t.books.push(b),console.log("added"),t.uploading=!1,t.refresh()};return n.jsxs("div",{className:"p-3 fixed inset-0 bg-gradient-to-br from-purple-100 via-purple-300 to-purple-500",children:[t.uploading?n.jsx("div",{className:"fixed inset-0 z-[10000] backdrop-blur-sm",children:n.jsx(w,{color:"white"})}):"",n.jsxs("main",{className:"grid grid-cols-2 gap-4 overflow-auto",children:[t.books.length>0&&t.books.map((e,a)=>n.jsxs(g,{href:"/book",className:"relative w-full flex place-items-center place-content-center rounded-[10%] border-3 border-white",onClick:()=>{t.book=e},children:[n.jsx("div",{className:"w-full pb-[100%] bg-cover rounded-[10%]",style:{backgroundImage:`url(${URL.createObjectURL(e.cover)})`}}),n.jsx("div",{className:"absolute bottom-0 w-full h-full rounded-[10%] bg-black/50",onContextMenu:async s=>{confirm(`删除${e.title}`)&&(await t.db.delete("blobs",e.id),await t.db.delete("infos",e.id),t.books=t.books.filter(r=>r.id!=e.id),localStorage.clear(e.id),t.refresh())}}),n.jsx("div",{className:"p-1 absolute bottom-0 text-center text-xm text-white",children:e.title})]},a)),n.jsx("div",{className:"relative w-full rounded-[10%] border-3 border-white",onClick:()=>o.current.click(),onContextMenu:async()=>{confirm("删除全部")&&(t.books.forEach(e=>{localStorage.clear(e.id)}),await t.db.clear("blobs"),await t.db.clear("infos"),t.books=[],t.refresh())},children:n.jsx("div",{className:"w-full pb-[100%] relative",children:n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2",width:"35",height:"35",fill:"currentColor",viewBox:"0 0 16 16",children:n.jsx("path",{fillRule:"evenodd",d:"M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"})})})})]}),n.jsx("input",{type:"file",multiple:!0,ref:o,accept:".zip",className:"hidden",onChange:c})]})}export{k as default};
