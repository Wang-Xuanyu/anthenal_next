import{r as m,j as n}from"./About-dplKy6fd.js";import{H as g,L as w}from"./Book-D0YsG2KY.js";function v(t){t=t.split(" --> ")[0];var o=t.split(":"),c=parseInt(o[0]),e=parseInt(o[1]),s=o[2].split(","),r=parseInt(s[0]),a=parseInt(s[1]),l=c*3600+e*60+r+a/1e3;return[l,t]}function j(t,o){return t.replace(/\r\n/mg,`
`).split(`

`).map((e,s)=>{let r=e.split(`
`),a="";for(let i=2;i<r.length;i++)a+=r[i]+" ";let l={id:parseInt(r[0]),time:`${r[1]}`,text:a};if(l.time!="undefined")return l}).filter(e=>e).map(e=>{let[s,r]=v(e.time);return e.start=r,e.time=s,e}).reduce((e,s)=>{if(s.text.toLowerCase().indexOf("chapter ")==0){let r={};return r.index=s.text,r.texts=[s],e.push(r),e}return e[e.length-1].texts.push(s),e},[])}async function x({json:t,audio:o,cover:c,srt:e}){const s=i=>new Promise((u,p)=>{const h=new FileReader;h.onload=()=>u(h.result),h.onerror=p,h.readAsText(i)}),r=await s(t);let a;try{a=JSON.parse(r)}catch{throw new Error("Invalid JSON file")}const l=await s(e);return{data:a,audio:o,cover:c,subtitle:l}}function y({ctx:t}){const o=m.useRef(null),c=async e=>{const s=Array.from(e.target.files);let r,a,l,i,u;s.forEach(f=>{const d=f.name.toLowerCase();d.endsWith(".json")?r=f:d.endsWith(".mp3")||d.endsWith(".webm")?a=f:d.endsWith(".jpg")||d.endsWith(".jpeg")||d.endsWith(".png")||d.endsWith(".webp")?l=f:d.endsWith(".srt")&&(i=f)}),t.uploading=!0,t.refresh();const p=await x({json:r,audio:a,cover:l,srt:i});u=p.data,i=p.subtitle,a=p.audio,l=p.cover;let h=j(i),b={id:u.id,cover:l};b=Object.assign({},b,u),await t.db.add("infos",b),await t.db.add("blobs",{id:u.id,audio:a,text:h}),t.books.push(b),console.log("added"),t.uploading=!1,t.refresh()};return n.jsxs("div",{className:"p-3 fixed inset-0 bg-gradient-to-br from-purple-100 via-purple-300 to-purple-500",children:[t.uploading?n.jsx("div",{className:"fixed inset-0 z-[10000] backdrop-blur-sm",children:n.jsx(g,{color:"white"})}):"",n.jsxs("main",{className:"grid grid-cols-2 gap-4 overflow-auto",children:[t.books.length>0&&t.books.map((e,s)=>n.jsxs(w,{href:"/book",className:"relative w-full flex place-items-center place-content-center rounded-[10%] border-3 border-white",onClick:()=>{t.book=e},children:[n.jsx("div",{className:"w-full pb-[100%] bg-cover rounded-[10%]",style:{backgroundImage:`url(${URL.createObjectURL(e.cover)})`}}),n.jsx("div",{className:"absolute bottom-0 w-full h-full rounded-[10%] bg-black/50",onContextMenu:async r=>{confirm(`删除${e.title}`)&&(await t.db.delete("blobs",e.id),await t.db.delete("infos",e.id),t.books=t.books.filter(a=>a.id!=e.id),localStorage.clear(e.id),t.refresh())}}),n.jsx("div",{className:"p-1 absolute bottom-0 text-center text-xm text-white",children:e.title})]},s)),n.jsx("div",{className:"rounded-[10%] flex place-content-center place-items-center w-full border-3 border-white",onClick:()=>o.current.click(),onContextMenu:async()=>{confirm("删除全部")&&(t.books.forEach((e,s)=>{localStorage.clear(e.id)}),await t.db.clear("blobs"),await t.db.clear("infos"),t.books=[],t.refresh())},children:n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"35",height:"35",fill:"currentColor",viewBox:"0 0 16 16",children:n.jsx("path",{fillRule:"evenodd",d:"M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"})})})]}),n.jsx("input",{type:"file",multiple:!0,ref:o,accept:".zip",className:"hidden",onChange:c})]})}export{y as default};
